# [PackageDev] target_format: plist, ext: tmLanguage
---
name: TaskJuggler
scopeName: source.tjp3
fileTypes: [tjp3]
# Arbitrary UUID, until I figure out where this is used.
uuid: 24341012-fbff-4468-926e-348ed6563de2

macros:
  ID: (?:\b[a-zA-Z_][a-zA-Z0-9_]*\b)
  stringDoubleQuoted: \"(?:[^\"\\]|\\.)+\"
  stringSingleQuoted: \'(?:[^\'\\]|\\.)+\'
  stringSingleLine: (?:{{stringDoubleQuoted}}|{{stringSingleQuoted}})
  endOfListAttribute: (?:(?<![,\s])\s*$)
  timestamp: (?:\d\d\d\d-\d\d-\d\d(?:-\d\d:\d\d(?::\d\d)?)?(?:-[+-]\d\d\d\d)?)
  float: (?:\d+\.\d+)
  integer: (?:\d+)
  numeric: (?:{{float}}|{{integer}})
  durationUnits: (?:min|h|d|w|m|y)

patterns:
- include: '#account'

repository:
  account:
    patterns:
    # Order matters: Multi-line pattern must preceded the single line version.
    - begin: '^\s*(account)\b\s*(?:({{ID}})\s+)?({{stringSingleLine}})\s*\{'
      end: '\}'
      beginCaptures:
        '1': { name: storage.type.account.tjp3 }
        '2': { name: entity.name.type.account.tjp3 }
        '3': { name: string.quoted.tjp3 }
      patterns:
        - include: '#literals'
        - include: '#flags'
        - include: '#credits'
    - match: '^\s*(account)\b\s*(?:({{ID}})\s+)?({{stringSingleLine}})'
      captures:
        '1': { name: storage.type.account.tjp3 }
        '2': { name: entity.name.type.account.tjp3 }
        '3': { name: string.quoted.tjp3 }
  flags:
    patterns:
      - begin: '^\s*(flags)\b'
        end: '{{endOfListAttribute}}'
        beginCaptures:
          '1': { name: storage.type.flags.tjp3 }
        patterns:
          - include: '#literals'
          - name: entity.name.type.flags.tjp3
            match: '{{ID}}'
  credits:
    patterns:
      - begin: '^\s*(credits)\b'
        end: '{{endOfListAttribute}}'
        beginCaptures:
          '1': { name: storage.type.credits.tjp3 }
        patterns:
          - include: '#literals'
          - include: '#string'
          - include: '#date'
          - include: '#numeric'
  literals:
    patterns:
      - include: '#string'
      # Order matters: date must precede subsumbed numeric
      - include: '#date'
      - include: '#numeric'
  string:
    patterns:
      - name: string.quoted.tjp3
        match: '{{stringSingleLine}}'
  numeric:
    patterns:
      - name: constant.numeric.tjp3
        match: '{{numeric}}'
  date:
    patterns:
      # Order matters. This pattern must precede the simpler timestamp pattern
      # without duration offset.
      - name: constant.numeric.date.tjp3
        match: '%\s*\{\s*{{timestamp}}\s*[+-]\s*{{numeric}}\s*{{durationUnits}}\s*\}'
      - name: constant.numeric.date.tjp3
        match: '{{timestamp}}'
